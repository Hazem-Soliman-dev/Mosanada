// Mosanada SaaS — Prisma Schema
// Multi-tenant subscription management with double-entry bookkeeping

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum Role {
  ADMIN
  MEMBER
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAUSED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  VOID
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  CASH
  OTHER
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum NormalBalance {
  DEBIT
  CREDIT
}

// ─── Models ──────────────────────────────────────────────

model Tenant {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users          User[]
  plans          Plan[]
  customers      Customer[]
  subscriptions  Subscription[]
  invoices       Invoice[]
  payments       Payment[]
  accounts       Account[]
  journalEntries JournalEntry[]
}

model User {
  id       String @id @default(uuid())
  tenantId String
  email    String
  password String
  role     Role   @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
}

model Plan {
  id           String       @id @default(uuid())
  tenantId     String
  name         String
  price        Decimal      @db.Decimal(12, 2)
  billingCycle BillingCycle  @default(MONTHLY)
  isActive     Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
}

model Customer {
  id       String  @id @default(uuid())
  tenantId String
  name     String
  email    String
  phone    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  invoices      Invoice[]

  @@unique([tenantId, email])
}

model Subscription {
  id                 String             @id @default(uuid())
  tenantId           String
  customerId         String
  planId             String
  status             SubscriptionStatus @default(ACTIVE)
  startDate          DateTime
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  plan     Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  invoices Invoice[]
}

model Invoice {
  id             String        @id @default(uuid())
  tenantId       String
  subscriptionId String
  customerId     String
  amount         Decimal       @db.Decimal(12, 2)
  status         InvoiceStatus @default(PENDING)
  periodStart    DateTime
  periodEnd      DateTime
  dueDate        DateTime
  paidAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  payments     Payment[]

  @@unique([subscriptionId, periodStart, periodEnd])
}

model Payment {
  id        String        @id @default(uuid())
  tenantId  String
  invoiceId String
  amount    Decimal       @db.Decimal(12, 2)
  method    PaymentMethod @default(BANK_TRANSFER)
  paidAt    DateTime      @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Account {
  id            String        @id @default(uuid())
  tenantId      String
  code          String
  name          String
  type          AccountType
  normalBalance NormalBalance

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  journalEntryLines JournalEntryLine[]

  @@unique([tenantId, code])
}

model JournalEntry {
  id            String   @id @default(uuid())
  tenantId      String
  date          DateTime
  description   String
  referenceType String   // e.g. "INVOICE", "PAYMENT", "REVENUE_RECOGNITION"
  referenceId   String   // ID of the related entity

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lines  JournalEntryLine[]
}

model JournalEntryLine {
  id             String  @id @default(uuid())
  journalEntryId String
  accountId      String
  debit          Decimal @default(0) @db.Decimal(12, 2)
  credit         Decimal @default(0) @db.Decimal(12, 2)

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)
}
